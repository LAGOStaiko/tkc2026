name: Continuous Integration

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

jobs:
  install-lint-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Audit production dependencies
        run: pnpm audit --prod --audit-level high

      - name: Lint the code
        run: pnpm lint

      # - name: Analyze unused files and dependencies
      #   run: pnpm knip

      - name: Run Prettier check
        run: pnpm format:check

      - name: Run tests
        run: pnpm test

      - name: Build the project
        run: pnpm build

      - name: Smoke test build output
        run: |
          echo "Checking dist/index.html exists..."
          test -f dist/index.html
          echo "Checking _headers copied..."
          test -f dist/_headers
          echo "Checking SPA fallback routes resolve to index.html..."
          grep -q '<div id="root">' dist/index.html
          echo "All smoke checks passed."

      # ?? CSP ?섎룞 寃利?泥댄겕由ъ뒪??(諛고룷 ??釉뚮씪?곗? 肄섏넄 ?뺤씤) ??
      # 1. / ?????곸긽 ?몃꽕??i.ytimg.com) 濡쒕뱶, YouTube ?꾨쿋???ъ깮
      # 2. /apply ??Turnstile CAPTCHA ?꾩젽 ?뺤긽 ?뚮뜑留?
      # 3. /sign-in -- no external auth dependency page loads
      # 4. 肄섏넄??CSP Report-Only ?꾨컲 濡쒓렇 0嫄??뺤씤
      # 5. ?꾨컲 0嫄??뺤씤 ??_headers?먯꽌 Report-Only ??enforce ?꾪솚
