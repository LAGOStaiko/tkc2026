# TKC2026 Security Handover (2026-02-28)

## Scope
- Frontend apply flow (`src/components/tkc/apply-page.tsx`)
- Register API (`functions/api/register.ts`)
- Ops auth and ops APIs (`functions/_lib/ops-auth.ts`, `functions/api/ops/*`)
- Shared response and guard libraries

## Important Platform Note
- `public/_headers` does **not** apply to responses generated by Pages Functions.
- For `/api/*`, security and cache headers must be set in Functions code.
- This repository now enforces API-sensitive headers via response utilities and per-route usage.

## Security Controls Implemented

### 1. Register Request Hardening
- Enforces `Content-Type: application/json` for `POST /api/register`.
- Adds bounded body parsing with max size guard (`REGISTER_MAX_BODY_BYTES`, default `16KB`).
  - Rejects oversized requests by `Content-Length` pre-check and streaming size checks (`413`).
- Adds request-context guard (Fetch Metadata + Origin/Referer allowlist):
  - `Sec-Fetch-Site: cross-site` blocked in enforce mode.
  - `Origin`/`Referer` must match `ALLOWED_ORIGINS` when mode is enforce.
  - Mode controlled by `REGISTER_CSRF_MODE=off|log-only|enforce`.
  - Default mode:
    - production: `enforce`
    - staging/edit: `log-only`

### 2. Turnstile Hardening
- Adds explicit `TURNSTILE_MODE=off|conditional|required`.
- Default mode:
  - production: `required` (fail-closed default)
  - staging/edit: `conditional`
- In `required` mode, missing secret returns `503`.
- `siteverify` call now includes:
  - request timeout (AbortController)
  - `idempotency_key` (`crypto.randomUUID()`)
- Supports optional response checks:
  - `TURNSTILE_EXPECTED_HOSTNAMES`
  - `TURNSTILE_EXPECTED_ACTION`
- Keeps client-facing compatibility for known messages:
  - `Turnstile verification required`
  - `Turnstile verification failed`

### 3. Register Schema and Payload Safety
- `offlineSongs` now has `.max(4)` in schema to cap array growth.
- `qualifierRegion` now also passes formula-injection sanitization before GAS write.
- Existing honeypot (`website`) and length/conditional validations remain in place.

### 4. Ops Authentication Hardening
- Supports multiple operator keys in `OPS_OPERATOR_KEY` (comma-separated) for key rotation.
- Uses constant-time key comparison to reduce timing attack surface.
- Optional IP allowlist with `OPS_ALLOWED_IPS`:
  - IPv4 exact + CIDR supported (`198.51.100.0/24`)
  - IPv6 exact match supported
- Auth failure logs remain structured and avoid key/token/raw payload logging.

### 5. API Cache/Header Policy in Functions
- Added reusable `withNoStore()` response helper.
- Register and ops routes now return `Cache-Control: no-store` consistently.
- Security defaults for API responses include:
  - `X-Content-Type-Options: nosniff`
  - `Referrer-Policy: strict-origin-when-cross-origin`

## Rate Limit Fix (Bugfix Summary)

### Before
- Integer parsing treated `undefined`/blank as `0`, then clamped to min.
- Side effects:
  - rate-limit window fell to min (`60s`) unexpectedly
  - max requests fell to min (`1`) unexpectedly
  - GAS timeout/retry defaults were not honored in missing-env cases

### After
- Shared parser (`functions/_lib/number.ts`) treats `undefined/null/""/whitespace` as missing input and uses fallback.
- `functions/_lib/rate-limit.ts` and `functions/_lib/gas.ts` now share this parser.
- Effective defaults restored:
  - register rate limit: `10 minutes / 30 requests`
  - GAS fetch timeout default: `12,000ms`
  - GAS read retries default: `1`

## Environment Variables (Current Matrix)
- `ALLOWED_ORIGINS`
- `REGISTER_CSRF_MODE` (`off|log-only|enforce`)
- `REGISTER_MAX_BODY_BYTES`
- `TURNSTILE_MODE` (`off|conditional|required`)
- `TURNSTILE_SECRET_KEY`
- `TURNSTILE_EXPECTED_HOSTNAMES` (optional)
- `TURNSTILE_EXPECTED_ACTION` (optional)
- `OPS_OPERATOR_KEY` (supports comma-separated rotation keys)
- `OPS_ALLOWED_IPS` (optional)
- `RATE_LIMIT_KV`
- `RATE_LIMIT_WINDOW_MS`
- `RATE_LIMIT_MAX`
- Existing GAS settings:
  - `GAS_API_KEY`
  - `GAS_WEBAPP_URL` / tier-specific URLs
  - `TKC_ENV_TIER`

## NAT / Shared Network Operations Guide
- IP-based rate limiting can over-block under large NAT/shared networks.
- Recommended tuning strategy:
  1. Keep `TURNSTILE_MODE=required` in production.
  2. Increase `RATE_LIMIT_MAX` gradually when false positives are observed.
  3. Keep `REGISTER_CSRF_MODE=enforce` for production unless temporary mitigation is needed.
  4. Monitor `429` trends and adjust per event period.
